flowchart TD

    %% Frontend
    subgraph FE[Frontend: Boardroom]
    FE_Chat["Chat UI (polls host for messages)"]
    FE_Dash["Dashboard (renders MCP-UI schema)"]
    FE_Demo["Demo/Training UI (calls host AML APIs)"]
    end

    %% Host App
    subgraph HOST["Azure Functions Host App (Consumption Plan)"]
        MCPUI["MCP-UI Module: Reads manifest.mcpUi, Generates UI schema, Maps UI actions → SK agents"]
        GOV["Governance / Validation: Role/scope/tool checks, Policy engine"]
        AMLMGR["AML Manager: Start/stop AML endpoints, Route inference to LoRA, Trigger LoRA training, Monitor jobs"]
        PERSIST["Persistence: Azure Table Storage"]
        API["HTTP APIs: /messages, /dashboard, /aml/infer, /aml/train"]
        QTRIG["Async Queue Trigger (Azure Storage Queue)"]
    end

    %% Queue
    subgraph QUEUE["Azure Storage Queue"]
        QMSG["Low-cost async message bus (Triggers host functions)"]
    end

    %% SK Agents
    subgraph SK[Semantic Kernel Multi-Agents]
        CMO[CMO Agent → Marketing LoRA]
        CFO[CFO Agent → Finance LoRA]
        CTO[CTO Agent → Tech LoRA]
    end

    %% AML
    subgraph AML["Azure Machine Learning"]
        LORAs["LoRA Adapters per domain (registered models)"]
        ENDPTS["Online Endpoints (consumption, scale-to-zero)"]
        TRAIN["Training Pipelines (triggered by host)"]
        REG["Model Registry"]
    end

    %% Frontend to Host
    FE_Chat -->|polls /messages| API
    FE_Dash -->|fetches /dashboard| MCPUI
    FE_Demo -->|calls /aml APIs| AMLMGR

    %% Host internals
    MCPUI --> GOV
    GOV -->|valid action| SK
    GOV -->|persist system msgs| PERSIST
    QTRIG --> GOV
    API --> PERSIST

    %% SK Agents to Host
    SK -->|emit messages| QMSG
    QMSG --> QTRIG

    %% SK Agents to AML
    CMO -->|inference| ENDPTS
    CFO -->|inference| ENDPTS
    CTO -->|inference| ENDPTS

    %% AML Manager to AML
    AMLMGR -->|start/stop endpoints| ENDPTS
    AMLMGR -->|route inference| ENDPTS
    AMLMGR -->|trigger training| TRAIN
    TRAIN --> REG
    REG --> LORAs
    LORAs --> ENDPTS

    %% AML results back to SK
    ENDPTS --> SK

    %% Persistence to Frontend
    PERSIST -->|queried by polling| FE_Chat