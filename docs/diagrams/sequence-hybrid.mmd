sequenceDiagram
    autonumber
    participant FE as Frontend (Boardroom)
    participant HOST as Host App (Azure Functions - Consumption)
    participant MCPUI as MCP‑UI Module
    participant GOV as Governance / Validation
    participant SK as Semantic Kernel Multi‑Agents
    participant AMLMGR as AML Manager
    participant AML as Azure ML (LoRA Adapters)
    participant QUEUE as Azure Storage Queue
    participant TABLE as Azure Table Storage
    participant REG as AML Model Registry

    %% === UI-Driven Agent Call Flow ===
    Note over FE,SK: **UI‑Driven Agent Call (Production Inference)**
    FE->>HOST: Request dashboard schema (/dashboard)
    HOST->>MCPUI: Load manifest.mcpUi for role/scope
    MCPUI-->>FE: Return UI schema JSON

    FE->>HOST: User triggers action (via MCP‑UI)
    HOST->>GOV: Validate role/scope/tool
    GOV-->>HOST: Approved
    HOST->>SK: Invoke correct domain agent

    SK->>AMLMGR: Request inference from bound LoRA
    AMLMGR->>AML: Call Online Endpoint (consumption)
    AML-->>AMLMGR: Return inference result
    AMLMGR-->>SK: Deliver result to agent

    SK->>QUEUE: Emit message/event
    QUEUE->>HOST: Trigger Function (async)
    HOST->>GOV: Validate incoming message
    GOV->>TABLE: Persist message
    FE->>HOST: Poll /messages
    HOST->>TABLE: Query messages
    TABLE-->>HOST: Return ordered messages
    HOST-->>FE: Deliver chat updates

    %% === Direct AML Control Flow ===
    Note over FE,REG: **Direct AML Control (Demo / Training)**
    FE->>HOST: Request AML training (/aml/train) or inference (/aml/infer)
    HOST->>GOV: Validate request
    GOV-->>HOST: Approved
    HOST->>AMLMGR: Start endpoint or trigger training job
    AMLMGR->>AML: Run training pipeline or inference
    AML-->>AMLMGR: Job status / inference result
    AMLMGR-->>HOST: Return status/result
    HOST-->>FE: Deliver status/result to UI

    AML->>REG: Register/update LoRA adapter
    REG-->>SK: Bind updated LoRA to relevant agent