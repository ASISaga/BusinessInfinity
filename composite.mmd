flowchart TB
    %% === LAYERS ===
    subgraph UI[UI Layer]
        FE[Frontend (Boardroom UI)]
        MCPUI[MCP‑UI Module<br/>(Manifest Loader)]
    end

    subgraph HOST[Host / Orchestration Layer]
        HOSTAPP[Azure Functions - Consumption]
        GOV[Governance / Validation]
        QUEUE[Azure Storage Queue]
        TABLE[Azure Table Storage]
    end

    subgraph AGENTS[Agent Layer]
        SK[Semantic Kernel Multi‑Agents]
    end

    subgraph ML[ML Layer]
        AMLMGR[AML Manager]
        AML[Azure ML (LoRA Adapters)]
        REG[AML Model Registry]
    end

    %% === UI-Driven Agent Call Path (Production Inference) ===
    FE -->|Load manifest| MCPUI --> HOSTAPP
    FE -->|Trigger action| HOSTAPP --> GOV --> SK
    SK --> AMLMGR --> AML
    AML --> AMLMGR --> SK
    SK --> QUEUE --> HOSTAPP --> GOV --> TABLE --> FE

    %% === Direct AML Control Path (Demo / Training) ===
    FE -->|Train/Infer request| HOSTAPP --> GOV --> AMLMGR --> AML
    AML --> REG --> SK

    %% === Cross-layer bindings ===
    MCPUI -. manifest schema .-> SK
    REG -. updated LoRA binding .-> SK

    %% === Sequence cues (annotated) ===
    classDef seq fill=#f0f9ff,stroke=#007acc,stroke-width=1px;
    FE:::seq
    MCPUI:::seq
    HOSTAPP:::seq
    GOV:::seq
    SK:::seq
    AMLMGR:::seq
    AML:::seq
    QUEUE:::seq
    TABLE:::seq
    REG:::seq